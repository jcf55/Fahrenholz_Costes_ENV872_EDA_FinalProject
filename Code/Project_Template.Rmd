---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Comparison of Avian Clutch Size, Physical Characterists, and Mating Tactics"
subtitle: "https://github.com/jcf55/Fahrenholz_Costes_ENV872_EDA_FinalProject"
author: "Lydie Costes and Jackie Fahrenholz"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Get working directory
getwd()

# Load packages
library(tidyverse)
library(GGally)

# Set your ggplot theme
ourtheme <- theme_bw(base_size = 12) +
  theme(axis.text = element_text(color = "black"),
        legend.position = "top")
theme_set(ourtheme)

# Load datasets
birds <- read.csv("../Data/Raw/avian_ssd_jan07.csv")

# Set digit notation
options(scipen = 10)
```

# Rationale and Research Questions

According to the study from which this data was extracted, avian body size and their evolution over time there is much to be debated. Generally, there is agreement about the idea that body size of bird species impacts other characteristics. Because of this, this project intends to explore the correlation between body size of avian species with various measurements and observations in this dataset. First, we ask the question if female tail size predicts clutch size. Tail length has a significant impact on control and agility (Evans 1999). Longer tails increase crash risk as well as reduces the ability to maneuver (Evans 1999). We believe that this may have an overall negative impact on clutch size, as birds with longer tail lengths may be less efficient at collecting food for their young. To follow this analysis, we will explore tail length variation in comparison with methods of display, mating system, and resource sharing systems. 

\newpage

# Dataset Information

Our dataset consists of data that was collected starting in 2005 and was last updated in January of 2007. Data for this collection come from regions that include:

* Western Palearctic
* Neararctic
* Africa
* Australia
* New Zealand
* Antarctica

The complete dataset (represented below by the variable `birds`) includes 41 variables, and represents 146 families. According to the metadata, the majority of this information was gathered from ornithological handbooks, with some data obtained from personal communications with authors who published information on species bird groups. More information on the sources used can be found at: https://esapubs.org/archive/ecol/E088/096/metadata.htm (also in Data/Raw in the .tex file) 

\newpage

# Exploratory Analysis 
```{r explore_the_full_data}
#dimensions
dim(birds)
#column names
colnames(birds)
#variable types?
str(birds)
#look at the first few lines
head(birds)

```

```{r wrangle_the_data}
# Convert -999 to NAs and add genus column
birds <- birds %>%
  na_if(., -999) %>%
  separate(Species_name, 
           sep = " ", 
           into = c("Genus", "Sp"), 
           remove = FALSE)

# Subset to columns we are interested in
birds.subset <- birds %>%
  select(Family, Species_name, Genus, F_mass, F_bill,
          F_tail,Clutch_size, Mating_System, Display, 
          Resource)

# This function allows calculation of mode for categorical variables
Mode <- function(x) {
  ux <- unique(x) 
  ux[which.max(tabulate(match(x, ux)))]
}

# Group by family, average by mean or mode
birds.family <- birds.subset %>%
  group_by(Family) %>% 
  summarise(F_mass = mean(F_mass, na.rm = TRUE),
            F_bill = mean(F_bill, na.rm = TRUE),
            F_tail = mean(F_tail, na.rm = TRUE),
            Clutch_size = mean(Clutch_size, na.rm = TRUE),
            Common_Mating_System = Mode(Mating_System),
            Common_Display = Mode(Display),
            Common_Resource = Mode(Resource)) %>%
  filter(!is.na(Clutch_size), !is.na(Common_Mating_System),
         !is.na(Common_Display), !is.na(Common_Resource), 
         !is.na(F_tail), !is.na(F_mass), !is.na(F_bill))

#write the csv file into our Processed data folder
#write.csv(birds.subset, file = "./Data/Processed/birds_subset.csv")
#write.csv(birds.family, file = "./Data/Processed/birds_wrangled.csv")
```

```{r more_exploration}
# Work now from the processed file
birds.subset <- read_csv("./Data/Processed/birds_subset.csv")

# Set Family as a factor
birds.subset$Family <- as.factor(birds.subset$Family)

# Look at the data again, make sure it looks good
dim(birds.family)
colnames(birds.family)

# View variable distributions and relationships
ggpairs(birds.family)

# View the counts of our factor variables
count(birds.subset, vars = Mating_System) # SUPER uneven! This could be an issue contributing to uneven variances?
count(birds.subset, vars = Display)
```
\newpage

# Analysis

To test our hypotheses using our subset data `birds.family`, we will conduct a linear regression and an analysis of variance (ANOVA). Our first research question will be answered using a linear regression, while our second will be addressed with an ANOVA. Results will be clearly stated in words, and supplemented using graphing visualizations. 


NOTE FROM LYDIE: I wasn't actually thinking we would run our analysis at the family level; that's a pretty small sample size, especially with many families cut. I was just interested in grouping by family to explore wrangling and be able to visualize the data graphically and see whether there are patterns by family. I changed the ANOVA analyses accordingly and now we have significant results.


## Question 1: Does female tail length predict clutch size?
$H_0$ : There is no significant difference between female tail length and clutch size.
$H_A$ : There is a significant difference between female tail length and clutch size.


QUESTION FROM LYDIE: Should these stay our hypotheses and we say we are including mass to control for it, or should we include mass in our hypotheses?


```{r question_1}
# First, explore whether female mass predicts clutch size.
# This is not our research question, but is important to assess 
# whether our findings with tail length are simply explained by size.
summary(with(birds.subset, lm(Clutch_size ~ F_mass)))

# OK Jackie I don't think we can really proceed with our tail explorations unless we take into account mass. Bc the variation in tail might just be explained by overall size rather than relative tail length. 

# Do female mass and tail size predict clutch size?
summary(with(birds.subset, lm(Clutch_size ~ F_tail * F_mass)))
# Yes! Both mass and tail and their interaction are significant.
# p < 0.001, R2 = 0.022

# Plot the results
ggplot(birds.subset[], aes(x = F_mass, y = Clutch_size)) +
  geom_point(aes(color = F_tail), alpha = 0.8) +
  geom_smooth(method = "lm", se = F, color = "seagreen4") +
  labs(x = "Female Mass (g)", y = "Clutch Size", color = "Female Tail \nLength (mm)") +
  scale_x_continuous(limits = c(0, 12000)) +
  scale_color_viridis_c(option = "magma")
# figure out a way to hide or change the NAs color? 

ggplot(birds.subset[], aes(x = F_tail, y = Clutch_size)) +
  geom_point(aes(color = F_mass), alpha = 0.7) +
  geom_smooth(method = "lm", se = F, color = "seagreen4") +
  labs(x = "Female Tail Length (mm)", y = "Clutch Size", color = "Female Mass (g)") +
  scale_color_viridis_c(option = "magma")
# the colors on this one are meaningless unless we can trim the extremes

```

## Question 2: Does female tail length predict mating approaches?
$H_0$ : Mating system and display behavior do not predict tail size.
$H_A$ : Mating system and/or display behavior do predict tail size.

```{r question_2}
#### NOTE: Because I switched us back to working with the subset dataset, we can use any of the variables. I think it makes sense to include mating system and display behavior but eliminate resource sharing because I think this research question is about mating, but lmk if you disagree!

#test for normality
shapiro.test(birds.subset$F_tail) 
# Not normally distributed

qqnorm(birds.subset$F_tail); qqline(birds.subset$F_tail)
# looks like maybe a transformation is in order? Though we didn't really get into that in this class so maybe we can just call it a limitation

# test for equal variance
with(birds.subset, bartlett.test(F_tail ~ Display))
with(birds.subset, bartlett.test(F_tail ~ Mating_System))
# Both significant; the variances are not equal

# Form the anova
mating.anova <- aov(data = birds.subset, F_tail ~ Mating_System * Display)
summary(mating.anova) # significant

# Change settings to view all residual plots at once
par(mfrow=c(2,2))
# View residuals 
plot(mating.anova)
# Change settings back
par(mfrow=c(1,1))


```

\newpage

# Summary and Conclusions


\newpage

# References

Evans, M.R. 1999. The consequences of flight for the evolution of tail ornaments in birds. In: Adams, N.J. & Slotow, R.H. (eds) Proc. 22 Int. Ornithol. Congr., Durban: 1823-1843. Johannesburg: BirdLife South Africa.
