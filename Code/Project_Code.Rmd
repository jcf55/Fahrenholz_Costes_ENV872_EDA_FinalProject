---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Comparison of Avian Clutch Size, Physical Characterists, and Mating Tactics"
subtitle: "https://github.com/jcf55/Fahrenholz_Costes_ENV872_EDA_FinalProject"
author: "Lydie Costes and Jackie Fahrenholz"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\listoffigures 
\newpage

```{r setup, include=FALSE}

#Get working directory
getwd()

# Load packages
library(tidyverse)
library(GGally)
library(car)
library(knitr)
library(psych)
library(agricolae)

# Set your ggplot theme
ourtheme <- theme_bw(base_size = 12) +
  theme(axis.text = element_text(color = "black"),
        legend.position = "right")
theme_set(ourtheme)

# Load datasets
birds <- read.csv("../Data/Raw/avian_ssd_jan07.csv")

# Set digit notation
options(scipen = 10)
```

# Rationale and Research Questions

According to the study from which this data was extracted, avian body size and the evolution of birds over time is a highly debated subject matter. Generally, there is agreement around the idea that body size of bird species impacts other characteristics. Because of this, this project intends to explore the correlation between body size and various measurements and observations in our data. 

First, we ask the question if female tail size predicts clutch size. Tail length has a significant impact on control and agility (Evans 1999). Longer tails increase crash risk as well as reduces the ability to maneuver (Evans 1999). We believe that this may have an overall negative impact on clutch size, as birds with longer tail lengths may be less efficient at collecting food for their young. Second, we will explore interactions between male tail length and methods of display, mating system, and resource sharing systems. Tail length likely has a negative impact on navigation, and collecting food, while having a positive impact on sexual display. Physical characteristics of males are evaluated by females in search of a mate. 

# Dataset Information

Our dataset consists of data that was collected starting in 2005 and was last updated in January of 2007. Data for this collection come from regions that include:

* Western Palearctic
* Neararctic
* Africa
* Australia
* New Zealand
* Antarctica

The complete dataset (represented below by the variable `birds`) includes 41 variables, and represents 125 families. According to the metadata, the majority of this information was gathered from ornithological handbooks, with some data obtained from personal communications with authors who published information on species bird groups. More information on the sources used can be found at: https://esapubs.org/archive/ecol/E088/096/metadata.htm (also in /Data/Raw in the .tex file) 

\newpage

# Exploratory Analysis 
```{r explore_the_full_data}
#dimensions
dim(birds)
#column names
colnames(birds)
#variable types?
str(birds)
#look at the first few lines
head(birds)

# make sure family column is named correctly
colnames(birds)[1] <- "Family"
```

```{r wrangle_the_data, warning = FALSE, message = FALSE}
# Convert -999 to NAs and add genus column
birds <- birds %>%
  na_if(., -999) %>%
  separate(Species_name, 
           sep = " ", 
           into = c("Genus", "Sp"), 
           remove = FALSE)

# Subset to columns we are interested in
birds.subset <- birds %>%
  select(Family, Species_name, Genus, F_mass, M_mass, 
         F_tail, M_tail, Clutch_size, Mating_System, 
         Display, Resource)

# This function allows calculation of mode for categorical variables
Mode <- function(x) {
  ux <- unique(x) 
  ux[which.max(tabulate(match(x, ux)))]
}

# Group male tail length by mating system to graph later
birds.mating.tail <- birds.subset %>%
  group_by(Mating_System) %>%
  summarise(M_tail = mean(M_tail, na.rm = TRUE))

# Group by family, average by mean or mode
birds.family <- birds.subset %>%
  group_by(Family) %>% 
  summarise(F_mass = mean(F_mass, na.rm = TRUE),
            M_mass = mean(M_mass, na.rm = TRUE),
            F_tail = mean(F_tail, na.rm = TRUE),
            M_tail = mean(M_tail, na.rm = TRUE),
            Clutch_size = mean(Clutch_size, na.rm = TRUE),
            Common_Mating_System = Mode(Mating_System),
            Common_Display = Mode(Display),
            Common_Resource = Mode(Resource)) %>%
  filter(!is.na(Clutch_size), !is.na(F_tail), 
         !is.na(F_mass), !is.na(M_tail))

# Set categorical variables as factors
birds.subset$Family <- as.factor(birds.subset$Family)
birds.subset$Mating_System <- as.factor(birds.subset$Mating_System)
birds.subset$Display <- as.factor(birds.subset$Display)
birds.subset$Resource <- as.factor(birds.subset$Resource)

# Write the csv file into our Processed data folder
write.csv(birds.subset, file = "../Data/Processed/birds_subset.csv")
write.csv(birds.family, file = "../Data/Processed/birds_family.csv")
```

```{r explore_processed_dataset, include = FALSE}
# Look at the data again, make sure it looks good
dim(birds.subset)
summary(birds.subset)
str(birds.subset)
```

```{r gg exploration, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9}
# View variable distributions and relationships
gg.birds.subset <- subset(birds.subset, select = -c(Family, Species_name, Genus))
ggpairs(gg.birds.subset)

# View the counts of our factor variables
count(birds.subset, vars = Mating_System) 
# SUPER uneven! This could be an issue contributing to uneven variances?
count(birds.subset, vars = Display) # Also uneven but not quite as bad
count(birds.subset, vars = Resource) # Looks fine
```

```{r summary table, echo = FALSE}
# Create summary table (using "psych" package)
birds_summary <- describe(birds.subset[,c("F_mass", "M_mass", "F_tail", "M_tail", "Clutch_size")], fast = T)

kable(birds_summary, caption = "Summary Statistics for Continuous Variables")

```

```{r exploratory_plots, echo = FALSE, warning = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# Boxplot of families vs clutch size
ggplot(birds.subset) +
  geom_boxplot(aes(x = Family, y = Clutch_size)) +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank()) +
  ylab("Clutch Size")
```

```{r r exploratory_plots_1, echo = FALSE, warning = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# Boxplot of families vs female tail
ggplot(birds.subset) +
  geom_boxplot(aes(x = Family, y = F_tail)) +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank()) +
  ylab("Female Tail Length (mm)")
```

```{r r exploratory_plots_2, echo = FALSE, warning = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# Boxplot of families vs male tail
ggplot(birds.subset) +
  geom_boxplot(aes(x = Family, y = M_tail)) +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank()) +
  ylab("Male Tail Length (mm)")
# Similar to female tail pattern but more extreme values probably represent families with sexual selection more impacting tail length
```

```{r regression}
# Run regression to compare male and female tail length
lm.tail <- lm(data = birds.subset, M_tail ~ F_tail)
# Check summary
summary(lm.tail) # highly correlated
```

```{r r exploratory_plots_3, echo = FALSE, warning = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# View relationship
ggplot(birds.subset, aes(x = F_tail, y = M_tail)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  labs(x = "Female Tail Length (mm)", y = "Male Tail Length (mm)")
# again, unusually high male tail lengths probably represent species with sexual selection more impacting tail length
```

```{r r exploratory_plots_4, echo = FALSE, warning = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# Boxplot of mating system vs male tail length
ggplot(birds.subset) +
  geom_boxplot(aes(x = Mating_System, y = M_tail)) +
  labs(y = "Male Tail Length (mm)", x = "Mating System")
```

```{r r exploratory_plots_5, echo = FALSE, warning = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# Boxplot of display system vs male tail length
ggplot(birds.subset) +
  geom_boxplot(aes(x = Display, y = M_tail)) +
  labs(y = "Male Tail Length (mm)")
```

```{r exploratory_plots_6, echo = FALSE, fig.cap = "Exploratory Plot of Wrangled Data"}
# Boxplot of resource system vs male tail length
ggplot(birds.subset) +
  geom_boxplot(aes(x = Resource, y = M_tail)) +
  labs(y = "Male Tail Length (mm)")
```
\newpage

# Analysis

To test our hypotheses using our subset data `birds.subset`, we will conduct a linear regression and an analysis of variance (ANOVA). Our first research question will be answered using a linear regression, while our second will be addressed with an ANOVA. Results will be clearly stated in words, and supplemented using graphing visualizations. 


## Question 1: Does female tail length predict clutch size?
$H_0$ : There is no significant difference between female tail length and clutch size.

$H_A$ : There is a significant difference between female tail length and clutch size.

Prior to conducting this anlaysis, it was identified that there is a strong correlation between mass and tail length. We therefore included this variable in our model, to see the further implications of this. 


```{r question_1, waring = FALSE, message = FALSE, echo = FALSE}
# First, explore whether female mass and female tail length are correlated.
# If they are highly correlated, then effects of tail length could be explained by mass.
summary(with(birds.subset, lm(F_mass ~ F_tail)))
# They are, though R2 is fairly low so mass doesn't explain most variation in tail length.

# Do female mass and tail size predict clutch size?
lm.tailmass <- with(birds.subset, lm(Clutch_size ~ F_tail * F_mass))
summary(lm.tailmass)
# Yes! Both mass and tail and their interaction are significant.
# p < 0.001, R2 = 0.022

vif(lm.tailmass)
# A VIF below 5 indicates acceptable level of multicollinearity
```

```{r q -1 residuals, echo = FALSE, warning = FALSE, message= FALSE, fig.cap = "Residual Plots for Question 1"}
# Change settings to view all residual plots at once
par(mfrow=c(2,2))
# View residuals 
plot(lm.tailmass)
# The Residuals vs. Fitted and Q-Q plots don't look great - maybe this would be a good question for a TA (how to interpret these)

# Change settings back
par(mfrow=c(1,1))
```

``` {r q-1 plots, echo = FALSE, warning = FALSE, fig.cap = "Female Mass vs Clutch Size"}
# Plot the results
ggplot(birds.subset[], aes(x = F_mass, y = Clutch_size)) +
  geom_point(aes(color = F_tail), alpha = 1) +
  geom_smooth(method = "lm", se = F, color = "seagreen4") +
  labs(x = "Female Mass (g)", y = "Clutch Size", color = "Female Tail \nLength (mm)") +
  scale_x_continuous(limits = c(0, 12000)) +
  scale_color_viridis_c()
```

```{r q-1 plot zoom, echo = FALSE, warning = FALSE, fig.cap = "A Closer Look: Female Mass vs Clutch Size"}
ggplot(subset(birds.subset, F_mass<5000), aes(x = F_tail, y = Clutch_size)) +
  geom_point(aes(color = F_mass), alpha = 0.8) +
  geom_smooth(method = "lm", se = F, color = "seagreen4") +
  labs(x = "Female Tail Length (mm)", y = "Clutch Size", color = "Female Mass (g)") +
  scale_color_viridis_c() +
  scale_x_continuous(limits = c(0,400))
```

\newpage

## Question 2: Does male tail length relate to mating approaches?
$H_0$ : Mating system and display behavior do not predict tail size.

$H_A$ : Mating system and/or display behavior do predict tail size.

```{r question_2, warning = FALSE}
#test for normality
shapiro.test(birds.subset$M_tail) 
# Not normally distributed

qqnorm(birds.subset$M_tail); qqline(birds.subset$M_tail)

# test for equal variance
with(birds.subset, bartlett.test(M_tail ~ Display))
with(birds.subset, bartlett.test(M_tail ~ Mating_System))
# All significant; the variances are not equal

mating.anova <- aov(data = birds.subset, M_tail ~ Mating_System * Display * Resource)
summary(mating.anova)

# Reduce the model to achieve significance
# Remove 3-way interaction
mating.anova.1 <- update(mating.anova, .~.-Mating_System:Display:Resource) 
summary(mating.anova.1)

# Remove Display:Resource
mating.anova.2 <- update(mating.anova.1, .~.-Display:Resource) 
summary(mating.anova.2)

# Remove Mating_System:Resource
mating.anova.3 <- update(mating.anova.2, .~.-Mating_System:Resource) 
summary(mating.anova.3)

# Remove Resource
mating.anova.4 <- update(mating.anova.3, .~.-Resource) 
summary(mating.anova.4)
# Everything is significant.
# Not possible to run an AIC comparison because 
#the models do not contain the same number of observations.
# Go with mating.anova.4, which is M_tail ~ Mating_System * Display
```

```{r, eval = FALSE, warning = FALSE, message = FALSE}
#Grouping with Tukey HSD
anova.group <- HSD.test(mating.anova.4, "M_tail", group = TRUE)
anova.group
``` 

```{r q-2 residual, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Residual Plots for Question 2"}
# Change settings to view all residual plots at once
par(mfrow=c(2,2))
# View residuals 
plot(mating.anova.4)
# Change settings back
par(mfrow=c(1,1))
```

```{r q-2 plots, echo = FALSE, warning = FALSE, fig.cap = "Male Tail Length vs Mating Tactics", fig.width = 7}
# Graph results
ggplot(data = subset(subset(birds.subset, !is.na(Mating_System)), !is.na(Display)), aes(x = Mating_System, y = M_tail, color = Display)) +
  geom_boxplot() +
  labs(x = "Mating System", y = "Average Tail Length (mm)") +
  scale_x_discrete(labels = c("Polyandry", "Monogamy", "Mostly Monogamy", "Mostly Polygyny", "Promiscuous")) +
  scale_color_discrete(labels = c("Ground Displays", "Mostly Ground", "Ground & Aerial", "Aerial, Non-Acrobatic", "Aerial, Acrobatic")) +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust =1))

```

\newpage

# Summary and Conclusions

*Summarize your major findings from your analyses in a few paragraphs. What conclusions do you draw from your findings? Relate your findings back to the original research questions and rationale.*

## Part 1

The interaction between female mass and tail size predicts clutch size (p < 0.001, n = 1642, R^2^ = 0.022). The effect of female tail size varies depending on the mass of the species. 
* tail is negative; mass is positive; interaction is negative. I can't remember how to interpret all this with the interaction

Limitations, Part 1
(do we need to run more assumption tests for this one?)
* R2 is low - model doesn't explain very much of the variance
* residuals plots - ?

## Part 2

Mating system and display system together predict tail length (n = 476, is the p-value just the interaction p-value for this one?)

Limitations, Part 2
* tail is not normally distributed (consider transforming)
* groups do not have equal variance (especially not surprising with Mating System because the vast majority of the bird species are Type 2 - Monogamous).
* Need to check R2 for this one
* residual plots - ?


\newpage

# References

Evans, M.R. 1999. The consequences of flight for the evolution of tail ornaments in birds. In: Adams, N.J. & Slotow, R.H. (eds) Proc. 22 Int. Ornithol. Congr., Durban: 1823-1843. Johannesburg: BirdLife South Africa.

Lislevand, T., Figuerola, J., and SzÃ©kely, T. 2007. Avian body sizes in relation to fecundity, mating system, display behavior, and resource sharing. Ecology 88:1605.
